<script src="encoding_context.js"></script>
<script src="header_encoder.js"></script>
<script src="header_decoder.js"></script>

<input id="roundTripButton" type="button" value="Round-trip" />
<br />

<p>Header sets equal: <span id="headerSetsEqual"></span></p>

<textarea id="uncompressed" cols="40" rows="40">
:scheme: https
:host: www.google.com
:path: /
:method: GET
accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
accept-charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
accept-encoding: gzip,deflate,sdch
accept-language: en-US,en;q=0.8
user-agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.32 (KHTML, like Gecko) Chrome/27.0.1425.0 Safari/537.32
cache-control: max-age=0
:version: HTTP/1.1
custom-header: custom-value
p3p: 
</textarea>
<textarea id="encoderContext" cols="40" rows="40">
</textarea>
<textarea id="intermediate" cols="40" rows="40">
</textarea>
<textarea id="compressed" cols="40" rows="40">
</textarea>
<textarea id="decoderContext" cols="40" rows="40">
</textarea>
<textarea id="uncompressed2" cols="40" rows="40">
</textarea>


<script>
'use strict';

var headerSetsEqualSpan = document.getElementById('headerSetsEqual');

var uncompressedTextarea = document.getElementById('uncompressed');
var encoderContextTextarea = document.getElementById('encoderContext');
var intermediateTextarea = document.getElementById('intermediate');
var compressedTextarea = document.getElementById('compressed');
var decoderContextTextarea = document.getElementById('decoderContext');
var uncompressed2Textarea = document.getElementById('uncompressed2');
var roundTripButton = document.getElementById('roundTripButton');

var headerEncoder = new HeaderEncoder(REQUEST, 4);
var headerDecoder = new HeaderDecoder(REQUEST);

function headerSetFromString(str) {
  var headerStrs = str.split('\n');
  return headerStrs.map(function(headerStr) {
    var match = headerStr.match(/^(.*): ?(.*)$/);
    return match ? [match[1], match[2]] : null;
  }).filter(function(e) {
    return e;
  });
}

function headerSetToString(headerSet) {
  var str = '';
  for (var i = 0; i < headerSet.length; ++i) {
    var header = headerSet[i];
    str += header[0] + ': ' + header[1] + '\n';
  }
  return str;
}

// TODO(akalin): Handle lower-casing.
function headerCompare(header1, header2) {
  if (header1[0] < header2[0]) {
    return -1;
  }
  if (header1[0] > header2[0]) {
    return +1;
  }
  if (header1[1] < header2[1]) {
    return -1;
  }
  if (header1[1] > header2[1]) {
    return +1;
  }
  return 0;
}

function headerSetsEqual(headerSet1, headerSet2) {
  if (headerSet1.length != headerSet2.length) {
    return false;
  }
  var length = headerSet1.length;

  var headerSetCopy1 = headerSet1.slice(0);
  var headerSetCopy2 = headerSet2.slice(0);
  headerSetCopy1.sort(headerCompare);
  headerSetCopy2.sort(headerCompare);
  for (var i = 0; i < length; ++i) {
    if (headerCompare(headerSetCopy1[i], headerSetCopy2[i]) != 0) {
      return false;
    }
  }

  return true;
}

function doRoundTrip() {
  var input = uncompressedTextarea.value;
  var headerSet = headerSetFromString(input);

  uncompressedTextarea.value = headerSetToString(headerSet);

  var encodedHeaderSet = headerEncoder.encodeHeaderSet(headerSet);

  encoderContextTextarea.textContent =
    JSON.stringify(headerEncoder.encodingContext_, null, '  ');

  var inputLength = 0;
  for (var i = 0; i < headerSet.length; ++i) {
    inputLength += headerSet[i][0].length;
    inputLength += headerSet[i][1].length;
  }
  var outputLength = encodedHeaderSet.length;
  var compressionRatio = inputLength / outputLength;

  var intermediate = {
    inputLength: inputLength,
    outputLength: outputLength,
    compressionRatio: compressionRatio
  };
  intermediateTextarea.textContent = JSON.stringify(intermediate, null, '  ');

  var encodedHeaderSetStr = String.fromCharCode.apply(null, encodedHeaderSet);
  compressedTextarea.textContent = JSON.stringify(encodedHeaderSetStr);

  var deserializedHeaderSet = headerDecoder.decodeHeaderSet(encodedHeaderSet);

  decoderContextTextarea.textContent =
    JSON.stringify(headerDecoder.encodingContext_, null, '  ');

  uncompressed2Textarea.textContent = headerSetToString(deserializedHeaderSet);

  var doHeaderSetsEqual = headerSetsEqual(headerSet, deserializedHeaderSet);
  headerSetsEqualSpan.textContent = (doHeaderSetsEqual ? "true" : "false");
}

roundTripButton.addEventListener('click', doRoundTrip, false);
</script>
