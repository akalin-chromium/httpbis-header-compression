<script src="encoding_context.js"></script>
<script src="header_encoder.js"></script>
<script src="header_decoder.js"></script>
<script src="huffman.js"></script>
<script src="compressor.js"></script>

<input id="roundTripButton" type="button" value="Round-trip" />
<br />

<textarea id="uncompressed" cols="40" rows="40">
[
  [ ":host", "www.google.com" ],
  [ ":method", "GET" ],
  [ ":path", "/" ],
  [ ":scheme", "https" ],
  [ ":version", "HTTP/1.1" ],
  [ "accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" ],
  [ "accept-charset", "ISO-8859-1,utf-8;q=0.7,*;q=0.3" ],
  [ "accept-encoding", "gzip,deflate,sdch" ],
  [ "accept-language", "en-US,en;q=0.8" ],
  [ "cache-control", "max-age=0" ],
  [ "user-agent", "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.32 (KHTML, like Gecko) Chrome/27.0.1425.0 Safari/537.32" ],
  [ "custom-header", "custom-value" ],
  [ "p3p", "" ]
]
</textarea>
<textarea id="intermediate" cols="40" rows="40">
</textarea>
<textarea id="compressed" cols="40" rows="40">
</textarea>
<textarea id="uncompressed2" cols="40" rows="40">
</textarea>


<script>
'use strict';

var uncompressedTextarea = document.getElementById('uncompressed');
var intermediateTextarea = document.getElementById('intermediate');
var compressedTextarea = document.getElementById('compressed');
var uncompressed2Textarea = document.getElementById('uncompressed2');
var roundTripButton = document.getElementById('roundTripButton');

var headerEncoder = new HeaderEncoder(REQUEST, 4);
var headerDecoder = new HeaderDecoder(REQUEST);

function doRoundTrip() {
  var input = uncompressedTextarea.value;
  var headerSet = JSON.parse(input);
  var encodedHeaderSet = headerEncoder.encodeHeaderSet(headerSet);

  var inputLength = 0;
  for (var i = 0; i < headerSet.length; ++i) {
    inputLength += headerSet[i][0].length;
    inputLength += headerSet[i][1].length;
  }
  var outputLength = encodedHeaderSet.length;
  var compressionRatio = inputLength / outputLength;

  var intermediate = {
    inputLength: inputLength,
    outputLength: outputLength,
    compressionRatio: compressionRatio
  };
  intermediateTextarea.textContent = JSON.stringify(intermediate, null, '  ');

  var encodedHeaderSetStr = String.fromCharCode.apply(null, encodedHeaderSet);
  compressedTextarea.textContent = JSON.stringify(encodedHeaderSetStr);

  var deserializedHeaderSet = headerDecoder.decodeHeaderSet(encodedHeaderSet);

  uncompressed2Textarea.textContent =
    JSON.stringify(deserializedHeaderSet, null, '  ');
}

roundTripButton.addEventListener('click', doRoundTrip, false);
</script>
